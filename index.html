<html>

<head>
	<link rel="stylesheet" type="text/css" href="bnStyle.css" />
	<script src="bhtree.js"></script>
	<script src="graphics.js"></script>
	<script src="userInput.js"></script>
	<script src="fileIO.js"></script>
	<title>Barnes-Hut Tree Implementation in HTML/Javascript</title>
</head>

<body>
<h2>Barnes-Hut Implementation in HTML/Javascript</h2>
<p>A <a href="http://en.wikipedia.org/wiki/Barnes%E2%80%93Hut_simulation">Barnes-Hut Simulation</a> is an N-body simulation of gravitational interactions between point particles using the Barnes-Hut algorithm.</p>

<table>
	<tr>
		<td colspan=2>
			<div>
			<button type="button" onclick="randomBodies(100)">Add 100 Random Bodies</button>
			or Choose JSON Input File<input type="file" id="fileInputs" name="files[]" accept="json" /></br>
			<output id="fileList"></output>
			</div>
		</td>
	</tr>
	<tr>
		<td>
			<canvas id="bnCanvas"
					width="600" 
					height="400" >
			</canvas>
			<div>
				<table border=0>
					<tr>					
						<td><button type="button" onclick="toggleArrows()">Arrows Toggle</button></td>
						<td><button type="button" onclick="toggleShowBNtree()">BN Tree Show/Hide</button></td>
						<td><button type="button" onclick="toggleDEBUG()">Debug Toggle</button></td>
						<td><center><b>DEBUG <span id="debugLVL"></span></b></center></td>
						<td>0</td>
						<td><input id="debugSlider" type="range" min=0 max=1 value=0 step=1 onchange="setDEBUG(this.value)" /></td>
						<td>1</td>
					</tr>
				</table>
			</div>
		</td>
		<td>
			<div align=center>
				<button type="button" onclick="resetSys()">Reset</button>
				<button type="button" onclick="startSys()">Start</button>
				<button type="button" onclick="pauseSys()">Stop/Pause</button>
				<table border=0>
					<tr><td colspan=3>
						Bodies: <b><output id="bodyCount">0</output></b><br/>
						TIME: <b><output id="timeDisp">0.0</output></b><br/>
						DT: <b><span id="dtSliderVal">0.01</span></b>
					</td></tr>
					<tr><td colspan=3 align="center">
						
					</td></tr>
					<tr>
						<td>DT</td>
						<td>0.0001</td>
						<td><input type="range" min="-4" max="1" value="-2" step=0.1 onchange="setDT(this.value)" /></td>
						<td>10</td>
					</tr>
				</table>
			</div>
			<code>
				<div id="data"><b>Quick Start:</b><br/>- Add some bodies<br/>- Press <b>Start</b></div>
			</code>
		</td>
	</tr>
</table>

<p>
<ul>
	<li>Click to place body</li>
	<li>Click-Drag to set velocity of body</li>
	<li>No collision checks, Bodies exert no gravitation when outside canvas area (but still get attracted back in).</li>
	<li>Press e/d keys while dragging to change mass of body</li>
	<li>Press p to toggle system pause/run.</li>
	<li>Press s to step system once by time step dt.</li>
</ul>
</p>
<p>Check out the <a href="https://github.com/Elucidation/Barnes-Hut-Tree-N-body-Implementation-in-HTML-Js">Source Code</a> on GitHub.</p>

<script>
var canvas = document.getElementById('bnCanvas'),
    data = document.getElementById('data'),
    bodies = [],
    stats = {};
var c = canvas.getContext('2d');

// Basic update system step by time step dt
var T = 0; // current system time
var dt = 0.01;
var stepTime;

var timer;
var sysRunning = false;

drawArrows = false;
initGraphics();
initUI();
initFileIO();

function randomBodies(n) {
	for (var i = 0; i < n; i++)
		addBody({
			x: Math.random() * canvas.width,
			y: Math.random() * canvas.height,
			v: {
				x: Math.random() * 10 - 5,
				y: Math.random() * 10 - 5,
			},
			m: Math.random() * (m.max - m.min) + m.min
		});
}

function addBody(body) {
	if (!body.v || !body.v.x || !body.v.y)
		body.v = { x: 0, y: 0 };

	if (!body.a || !body.a.x || !body.a.y)
		body.a = { x: 0, y: 0 };

	bodies.push(body);
}

function doForces() {
	for (var i = 0; i < bodies.length; i++) {
		bodies[i].a.x = 0;
		bodies[i].a.y = 0;
	}
	
	var tree = new BHTree(canvas.width, canvas.height, bodies, true);
}

function step() {
	var now = new Date().getTime();


	//stats = tree.getStats();
	//console.log(stats);

	leapfrog();

	stepTime = new Date().getTime() - now;

	T += dt;

	refreshGraphics();
}

function forwardEuler() {
	move(dt);
	accelerate(dt);
}

function leapfrog() {
	move(0.5 * dt);
	doForces();
	accelerate(dt);
	move(0.5 * dt);
}

function move(dt) {
	for (var i = 0; i < bodies.length; i++) {
		bodies[i].x += bodies[i].v.x * dt;
		bodies[i].y += bodies[i].v.y * dt;
	}
}

function accelerate(dt) {
	for (var i = 0; i < bodies.length; i++) {
		bodies[i].v.x += bodies[i].a.x * dt;
		bodies[i].v.y += bodies[i].a.y * dt;
	}
}

function startSys() {
	timer = setInterval(step, 10);
	//gfxTimer = setInterval(refreshGraphics, 1000 / 60.0);
	sysRunning = true;
}

function pauseSys() {
	clearInterval(timer);
	//clearInterval(gfxTimer);
	sysRunning = false;
}
</script>

</body>

</html>
